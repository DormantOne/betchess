<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>BetChess â€” Strategic Resource Chess</title>

<!-- chessboard.js CSS -->
<link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">

<!-- Distinctive typography: Bitter (display) + IBM Plex Mono (data) -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bitter:wght@400;600;800;900&family=IBM+Plex+Mono:wght@400;500;700&display=swap" rel="stylesheet">

<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DESIGN: Industrial chess terminal â€” warm amber on
   charcoal. Betting terminal in a dim back-room chess club.
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

:root {
  --bg: #111210;
  --bg-raised: #191b18;
  --bg-sunken: #0c0d0b;
  --panel: rgba(22, 24, 20, 0.95);
  --amber: #e0a44c;
  --amber-dim: rgba(224, 164, 76, 0.10);
  --amber-mid: rgba(224, 164, 76, 0.25);
  --green: #5ccc6f;
  --green-dim: rgba(92, 204, 111, 0.12);
  --red: #e05252;
  --red-dim: rgba(224, 82, 82, 0.12);
  --blue: #5b9bd5;
  --blue-dim: rgba(91, 155, 213, 0.12);
  --purple: #a78bfa;
  --purple-dim: rgba(167, 139, 250, 0.12);
  --text: #ddd9d0;
  --text-dim: #7a7668;
  --border: #2c2e28;
  --border-hi: #3e4138;
  --highlight-1: rgba(224, 164, 76, 0.45);
  --highlight-2: rgba(160, 180, 170, 0.35);
  --highlight-3: rgba(120, 130, 125, 0.25);
  --highlight-free: rgba(92, 204, 111, 0.35);
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Bitter', Georgia, serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
}

body::before {
  content: '';
  position: fixed; inset: 0;
  background:
    radial-gradient(ellipse at 15% 30%, rgba(224,164,76,0.03) 0%, transparent 55%),
    radial-gradient(ellipse at 85% 70%, rgba(92,204,111,0.02) 0%, transparent 50%);
  pointer-events: none;
}

/* â”€â”€ Layout â”€â”€ */
.shell {
  display: grid;
  grid-template-columns: minmax(360px, 480px) 1fr;
  grid-template-rows: auto 1fr;
  min-height: 100vh;
  max-width: 1200px;
  margin: 0 auto;
}
@media (max-width: 900px) { .shell { grid-template-columns: 1fr; } }

/* â”€â”€ Top Bar â”€â”€ */
.topbar {
  grid-column: 1 / -1;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 22px;
  background: var(--bg-raised);
  border-bottom: 1px solid var(--border);
  gap: 12px;
  flex-wrap: wrap;
}
.logo { font-weight: 900; font-size: 1.3rem; letter-spacing: -0.5px; color: var(--amber); }
.logo .sub { font-weight: 400; font-size: 0.78rem; color: var(--text-dim); margin-left: 10px; letter-spacing: 0; }
.topbar-actions { display: flex; gap: 8px; align-items: center; }

/* â”€â”€ Pills â”€â”€ */
.pills { display: flex; gap: 6px; flex-wrap: wrap; align-items: center; }
.pill {
  display: inline-flex; align-items: center; gap: 5px;
  padding: 5px 10px;
  border: 1px solid var(--border);
  border-radius: 6px;
  font-size: 0.78rem;
  color: var(--text-dim);
  background: var(--bg-sunken);
  font-family: 'IBM Plex Mono', monospace;
  white-space: nowrap;
}
.pill b { color: var(--text); font-weight: 700; }
.pill.good { border-color: rgba(92,204,111,0.25); }
.pill.good b { color: var(--green); }
.pill.warn { border-color: rgba(224,164,76,0.25); }
.pill.warn b { color: var(--amber); }
.pill.bad { border-color: rgba(224,82,82,0.25); }
.pill.bad b { color: var(--red); }

/* â”€â”€ Board Column â”€â”€ */
.board-col {
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  border-right: 1px solid var(--border);
}
@media (max-width: 900px) { .board-col { border-right: none; border-bottom: 1px solid var(--border); } }

#board-wrap { width: 100%; max-width: 480px; margin: 0 auto; position: relative; }
#board { width: 100%; }

.board-info {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.78rem;
  color: var(--text-dim);
  padding: 0 2px;
}
.board-info .free-tag {
  display: inline-flex; align-items: center; gap: 4px;
  padding: 3px 8px; border-radius: 4px;
  background: var(--green-dim);
  border: 1px solid rgba(92,204,111,0.3);
  color: var(--green);
  font-weight: 700;
  cursor: pointer;
  transition: all 0.15s;
}
.board-info .free-tag:hover { background: rgba(92,204,111,0.2); }
.board-info .free-tag.disabled {
  opacity: 0.35; cursor: not-allowed;
  background: var(--bg-sunken);
  color: var(--text-dim);
  border-color: var(--border);
}

/* Bankroll bar */
.bank-bar { height: 5px; background: var(--bg-sunken); border: 1px solid var(--border); border-radius: 99px; overflow: hidden; }
.bank-fill { height: 100%; border-radius: 99px; background: linear-gradient(90deg, var(--green), var(--amber)); transition: width 0.5s cubic-bezier(0.22, 1, 0.36, 1); }
.bank-fill.low { background: linear-gradient(90deg, var(--red), var(--amber)); }

/* â”€â”€ Control Column â”€â”€ */
.ctrl-col {
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 14px;
  overflow-y: auto;
  max-height: calc(100vh - 60px);
}

/* â”€â”€ Buttons â”€â”€ */
button, .btn {
  font-family: 'Bitter', Georgia, serif;
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 8px 14px;
  font-size: 0.82rem;
  font-weight: 700;
  cursor: pointer;
  background: var(--bg-raised);
  color: var(--text);
  transition: all 0.12s ease;
  display: inline-flex; align-items: center; gap: 5px;
}
button:hover { background: var(--bg-sunken); border-color: var(--border-hi); }
button:active { transform: translateY(1px); }
button:disabled { opacity: 0.35; cursor: not-allowed; transform: none !important; }
button.primary { border-color: rgba(224,164,76,0.4); color: var(--amber); background: var(--amber-dim); }
button.primary:hover { background: var(--amber-mid); }
button.danger { border-color: rgba(224,82,82,0.3); color: var(--red); }
button.danger:hover { background: var(--red-dim); }
button.success { border-color: rgba(92,204,111,0.3); color: var(--green); }
button.success:hover { background: var(--green-dim); }
button.purple { border-color: rgba(167,139,250,0.3); color: var(--purple); background: var(--purple-dim); }
button.purple:hover { background: rgba(167,139,250,0.18); }
button.sm { padding: 5px 10px; font-size: 0.75rem; }
.btn-row { display: flex; gap: 8px; flex-wrap: wrap; }

/* â”€â”€ Offers â”€â”€ */
.offers { display: grid; gap: 8px; }
.offer {
  display: grid;
  grid-template-columns: 32px 1fr auto;
  align-items: center;
  gap: 12px;
  padding: 12px 14px;
  border: 1px solid var(--border);
  border-radius: 10px;
  background: var(--bg-sunken);
  cursor: default;
  transition: border-color 0.2s, background 0.2s, box-shadow 0.2s;
}
.offer:hover { border-color: var(--border-hi); }
.offer .rank {
  width: 28px; height: 28px;
  display: flex; align-items: center; justify-content: center;
  border-radius: 6px;
  font-weight: 900; font-size: 0.8rem;
  font-family: 'IBM Plex Mono', monospace;
}
.offer .rank.r1 { background: var(--amber-dim); color: var(--amber); border: 1px solid rgba(224,164,76,0.3); }
.offer .rank.r2 { background: rgba(160,176,168,0.08); color: #a0b0aa; border: 1px solid rgba(160,176,168,0.2); }
.offer .rank.r3 { background: rgba(120,130,125,0.06); color: #788280; border: 1px solid rgba(120,130,125,0.15); }
.offer .move-info { display: flex; flex-direction: column; gap: 1px; }
.offer .san { font-weight: 900; font-size: 1.05rem; letter-spacing: -0.3px; }
.offer .eval { font-family: 'IBM Plex Mono', monospace; font-size: 0.75rem; color: var(--text-dim); }
.offer .right { display: flex; align-items: center; gap: 10px; }
.offer .cost { font-family: 'IBM Plex Mono', monospace; font-weight: 700; color: var(--amber); font-size: 0.9rem; }

/* â”€â”€ LLM Paste Zone (Prymis-style) â”€â”€ */
.llm-zone {
  border: 1px solid rgba(167,139,250,0.3);
  border-radius: 10px;
  background: rgba(167,139,250,0.04);
  overflow: hidden;
}
.llm-zone-header {
  padding: 10px 14px;
  background: rgba(167,139,250,0.08);
  border-bottom: 1px solid rgba(167,139,250,0.15);
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
}
.llm-zone-header .title {
  font-weight: 800;
  font-size: 0.88rem;
  color: var(--purple);
}
.llm-zone-header .step-badge {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.72rem;
  padding: 2px 8px;
  border-radius: 4px;
  background: rgba(167,139,250,0.15);
  color: var(--purple);
}
.llm-zone-body { padding: 12px 14px; }
.llm-zone-body .instructions {
  font-size: 0.8rem;
  color: var(--text-dim);
  margin-bottom: 10px;
  line-height: 1.5;
}
.llm-zone-body .instructions b { color: var(--text); }

.llm-prompt-preview {
  background: var(--bg-sunken);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 10px 12px;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.72rem;
  line-height: 1.5;
  color: #8a9080;
  white-space: pre-wrap;
  max-height: 140px;
  overflow-y: auto;
  margin-bottom: 10px;
}
.llm-prompt-preview::-webkit-scrollbar { width: 4px; }
.llm-prompt-preview::-webkit-scrollbar-thumb { background: var(--border-hi); border-radius: 99px; }

.llm-paste-area {
  width: 100%;
  background: var(--bg-sunken);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text);
  padding: 10px 12px;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.82rem;
  min-height: 80px;
  resize: vertical;
}
.llm-paste-area:focus { outline: none; border-color: var(--purple); }
.llm-paste-area::placeholder { color: var(--text-dim); }

.launch-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
  gap: 6px;
  margin-top: 8px;
}

.llm-reasoning {
  margin-top: 8px;
  padding: 10px 12px;
  background: rgba(167,139,250,0.06);
  border: 1px solid rgba(167,139,250,0.15);
  border-radius: 8px;
  font-size: 0.8rem;
  color: var(--text-dim);
  line-height: 1.5;
  max-height: 120px;
  overflow-y: auto;
  display: none;
}
.llm-reasoning.show { display: block; }
.llm-reasoning .label { color: var(--purple); font-weight: 700; font-size: 0.75rem; margin-bottom: 4px; }

/* â”€â”€ Log â”€â”€ */
.log-box {
  background: var(--bg-sunken);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 10px 12px;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.72rem;
  line-height: 1.55;
  color: #8a9080;
  white-space: pre-wrap;
  max-height: 200px;
  overflow-y: auto;
}
.log-box::-webkit-scrollbar { width: 4px; }
.log-box::-webkit-scrollbar-thumb { background: var(--border-hi); border-radius: 99px; }

/* â”€â”€ Settings Drawer â”€â”€ */
.settings-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.55);
  z-index: 500; opacity: 0;
  pointer-events: none; transition: opacity 0.25s;
}
.settings-overlay.open { opacity: 1; pointer-events: all; }

.settings-drawer {
  position: fixed; top: 0; right: 0;
  width: min(440px, 90vw); height: 100vh;
  background: var(--bg-raised);
  border-left: 1px solid var(--border);
  z-index: 501;
  transform: translateX(100%);
  transition: transform 0.3s cubic-bezier(0.22, 1, 0.36, 1);
  display: flex; flex-direction: column;
  overflow-y: auto;
}
.settings-drawer.open { transform: translateX(0); }

.settings-header {
  padding: 18px 22px;
  border-bottom: 1px solid var(--border);
  display: flex; justify-content: space-between; align-items: center;
}
.settings-header h2 { font-size: 1.1rem; color: var(--amber); }
.settings-body { padding: 20px 22px; flex: 1; }

fieldset {
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 14px;
  margin-bottom: 16px;
  background: rgba(0,0,0,0.15);
}
legend { color: var(--amber); font-weight: 800; font-size: 0.88rem; padding: 0 6px; }
.field { margin: 10px 0; }
.field label { display: block; font-size: 0.8rem; color: var(--text-dim); margin-bottom: 4px; }
.field input, .field select, .field textarea {
  width: 100%;
  background: var(--bg-sunken);
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--text);
  padding: 8px 10px;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.85rem;
}
.field input:focus, .field select:focus, .field textarea:focus { outline: none; border-color: var(--amber); }
.field .hint { font-size: 0.72rem; color: var(--text-dim); margin-top: 3px; font-style: italic; }

/* Mode toggle */
.mode-toggle {
  display: flex;
  border: 1px solid var(--border);
  border-radius: 8px;
  overflow: hidden;
  background: var(--bg-sunken);
}
.mode-toggle .opt {
  flex: 1; padding: 8px 12px;
  text-align: center; cursor: pointer;
  font-size: 0.82rem; font-weight: 700;
  color: var(--text-dim);
  transition: all 0.15s;
  border: none; background: transparent;
  font-family: 'Bitter', Georgia, serif;
}
.mode-toggle .opt:not(:last-child) { border-right: 1px solid var(--border); }
.mode-toggle .opt.active { background: var(--amber-dim); color: var(--amber); }
.mode-toggle .opt:hover:not(.active) { background: rgba(255,255,255,0.03); }

.section-head {
  font-weight: 800; font-size: 0.88rem;
  color: var(--text); margin-bottom: 8px;
  display: flex; align-items: center; gap: 6px;
}

.status-line {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.8rem; color: var(--text-dim); padding: 6px 0;
}
.spin {
  display: inline-block; width: 12px; height: 12px;
  border: 2px solid var(--border-hi);
  border-top-color: var(--amber);
  border-radius: 50%;
  animation: spin 0.7s linear infinite;
  vertical-align: middle; margin-right: 4px;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* Toast */
.toast {
  position: fixed; bottom: 20px; left: 50%;
  transform: translateX(-50%) translateY(60px);
  background: var(--green); color: #111;
  padding: 10px 18px; border-radius: 8px;
  font-weight: 700; font-size: 0.85rem;
  opacity: 0;
  transition: all 0.3s cubic-bezier(0.22, 1, 0.36, 1);
  z-index: 600; pointer-events: none;
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
.toast.err { background: var(--red); color: white; }
</style>
</head>

<body>

<!-- â•â•â•â•â•â•â• Toast â•â•â•â•â•â•â• -->
<div class="toast" id="toast"></div>

<!-- â•â•â•â•â•â•â• Settings Drawer â•â•â•â•â•â•â• -->
<div class="settings-overlay" id="settingsOverlay"></div>
<div class="settings-drawer" id="settingsDrawer">
  <div class="settings-header">
    <h2>âš™ Settings</h2>
    <button class="sm" id="closeSettings">âœ• Close</button>
  </div>
  <div class="settings-body">

    <fieldset>
      <legend>Game Economy</legend>
      <div class="field">
        <label>Starting Bankroll ($)</label>
        <input type="number" id="s_bankroll" value="25" min="5" max="9999" step="1">
      </div>
      <div class="field">
        <label>Cost: Best Move (Rank 1)</label>
        <input type="number" id="s_cost1" value="3" min="0" max="99" step="1">
      </div>
      <div class="field">
        <label>Cost: Good Move (Rank 2)</label>
        <input type="number" id="s_cost2" value="2" min="0" max="99" step="1">
      </div>
      <div class="field">
        <label>Cost: Budget Move (Rank 3)</label>
        <input type="number" id="s_cost3" value="1" min="0" max="99" step="1">
      </div>
      <div class="field">
        <label>Free Moves per Game</label>
        <input type="number" id="s_freeMoves" value="1" min="0" max="20" step="1">
        <div class="hint">Drag any legal move at no cost. Limited per game.</div>
      </div>
    </fieldset>

    <fieldset>
      <legend>Engine</legend>
      <div class="field">
        <label>Analysis Depth (offers)</label>
        <input type="number" id="s_depthOffers" value="12" min="4" max="24" step="1">
      </div>
      <div class="field">
        <label>Stockfish Depth (opponent)</label>
        <input type="number" id="s_depthEngine" value="12" min="4" max="24" step="1">
      </div>
    </fieldset>

    <fieldset>
      <legend>Opponent</legend>
      <div class="field">
        <label>Play Against</label>
        <div class="mode-toggle" id="modeToggle">
          <button class="opt active" data-mode="stockfish">â™Ÿ Stockfish</button>
          <button class="opt" data-mode="llm">ğŸ§  LLM (paste)</button>
        </div>
        <div class="hint" style="margin-top:6px">LLM mode: copy prompt â†’ paste into any AI â†’ paste JSON response back. No API key needed.</div>
      </div>
      <div id="llmExtraSettings" style="display:none">
        <div class="field">
          <label>LLM System Prompt (customize AI opponent personality)</label>
          <textarea id="s_llmPrompt" rows="6" style="font-size:0.78rem;font-family:'IBM Plex Mono',monospace">You are a world-class chess grandmaster playing as Black. You are sharp, tactical, and aggressive. You look for initiative and counterplay.

Given the board state, move history, and list of legal moves, choose the single BEST move.

You MUST respond with a JSON object and nothing else:
{
  "move": "e7e5",
  "reasoning": "Brief explanation of why this move is strong"
}

RULES:
- "move" must be a UCI string from the legal moves list
- Keep reasoning under 200 characters
- No text outside the JSON object</textarea>
        </div>
      </div>
    </fieldset>

    <fieldset>
      <legend>ğŸ”’ Coming Soon</legend>
      <div class="field">
        <label style="color:var(--text-dim)">Opponent Move Bidding</label>
        <div class="hint">Bid $ to weaken opponent's move selection. Not yet implemented.</div>
      </div>
    </fieldset>

    <div class="btn-row" style="margin-top:12px">
      <button class="primary" id="applySettings">Apply & New Game</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â• Main Shell â•â•â•â•â•â•â• -->
<div class="shell">

  <!-- Top Bar -->
  <div class="topbar">
    <div>
      <span class="logo">â™Ÿ BetChess <span class="sub">resource-management chess</span></span>
    </div>
    <div class="topbar-actions">
      <div class="pills">
        <div class="pill"><span>Turn</span> <b id="ui_turn">â€”</b></div>
        <div class="pill good" id="pillBank"><span>Bank</span> <b id="ui_bank">$â€”</b></div>
        <div class="pill"><span>Move</span> <b id="ui_moveNum">0</b></div>
      </div>
      <button class="sm" id="btnSettings">âš™ Settings</button>
    </div>
  </div>

  <!-- Board Column -->
  <div class="board-col">
    <div id="board-wrap">
      <div id="board"></div>
    </div>
    <div class="bank-bar">
      <div class="bank-fill" id="bankFill" style="width:100%"></div>
    </div>
    <div class="board-info">
      <div class="status-line" id="ui_status">Loading engineâ€¦</div>
      <div>
        <span class="free-tag disabled" id="freeBtn" title="Use a free move (drag any legal piece)">
          FREE Ã—<span id="ui_freeCount">0</span>
        </span>
      </div>
    </div>
    <div class="log-box" id="log" style="max-height:120px"></div>
  </div>

  <!-- Control Column -->
  <div class="ctrl-col">
    <div class="btn-row">
      <button class="primary" id="btnNew">New Game</button>
      <button id="btnReroll">Re-roll Offers</button>
      <button class="danger" id="btnResign">Resign</button>
    </div>

    <!-- Offers section (shown during White's turn in both modes) -->
    <div class="section-head" id="offersTitle">Offers</div>
    <div class="offers" id="offers">
      <div style="color:var(--text-dim); font-size:0.85rem; font-style:italic;">Loading engineâ€¦</div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         LLM PASTE ZONE (Prymis-style)
         Shown during Black's turn when mode=llm
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="llm-zone" id="llmZone" style="display:none">
      <div class="llm-zone-header">
        <span class="title">ğŸ§  LLM Opponent â€” Paste Loop</span>
        <span class="step-badge" id="llmStep">Step 1: Copy</span>
      </div>
      <div class="llm-zone-body">

        <div class="instructions">
          <b>1)</b> Copy the prompt below â†’
          <b>2)</b> Paste into any AI (Claude, GPT, Geminiâ€¦) â†’
          <b>3)</b> Paste the JSON response back here â†’
          <b>4)</b> Click <b>Parse & Play</b>
        </div>

        <!-- Generated prompt (collapsed preview) -->
        <div class="llm-prompt-preview" id="llmPromptPreview"></div>

        <div class="btn-row">
          <button class="purple sm" id="llmCopyPrompt">ğŸ“‹ Copy Prompt</button>
          <button class="sm" id="llmCopySchema">ğŸ“‹ Copy Schema</button>
        </div>

        <!-- Quick-launch buttons -->
        <div class="launch-grid">
          <button class="sm" data-ai="claude">Claude</button>
          <button class="sm" data-ai="gpt">GPT</button>
          <button class="sm" data-ai="gemini">Gemini</button>
          <button class="sm" data-ai="deepseek">DeepSeek</button>
        </div>

        <!-- Paste-back area -->
        <div style="margin-top:12px">
          <textarea class="llm-paste-area" id="llmPaste" placeholder='Paste AI JSON response hereâ€¦&#10;{ "move": "e7e5", "reasoning": "..." }'></textarea>
        </div>
        <div class="btn-row" style="margin-top:8px">
          <button class="success" id="llmParsePlay">ğŸ” Parse & Play</button>
          <button class="sm" id="llmUseSF">â™Ÿ Use Stockfish Instead</button>
        </div>

        <!-- Reasoning display (shown after parse) -->
        <div class="llm-reasoning" id="llmReasoning">
          <div class="label">ğŸ§  AI Reasoning</div>
          <div id="llmReasoningText"></div>
        </div>

      </div>
    </div>

    <!-- Opponent info -->
    <div class="section-head" style="margin-top:8px">Opponent</div>
    <div class="pill" id="ui_opponent" style="width:fit-content">â™Ÿ Stockfish depth 12</div>

    <!-- Verbose log -->
    <div class="section-head" style="margin-top:8px">Engine Log</div>
    <div class="log-box" id="verboseLog" style="max-height:180px"></div>
  </div>

</div>

<!-- â•â•â•â•â•â•â• Dependencies â•â•â•â•â•â•â• -->
<script src="https://unpkg.com/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

<script>
(function () {
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PIECE IMAGES â€” Wikimedia Commons SVGs (reliable + hi-res)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const PIECE_URLS = {
  wK: 'https://upload.wikimedia.org/wikipedia/commons/4/42/Chess_klt45.svg',
  wQ: 'https://upload.wikimedia.org/wikipedia/commons/1/15/Chess_qlt45.svg',
  wR: 'https://upload.wikimedia.org/wikipedia/commons/7/72/Chess_rlt45.svg',
  wB: 'https://upload.wikimedia.org/wikipedia/commons/b/b1/Chess_blt45.svg',
  wN: 'https://upload.wikimedia.org/wikipedia/commons/7/70/Chess_nlt45.svg',
  wP: 'https://upload.wikimedia.org/wikipedia/commons/4/45/Chess_plt45.svg',
  bK: 'https://upload.wikimedia.org/wikipedia/commons/f/f0/Chess_kdt45.svg',
  bQ: 'https://upload.wikimedia.org/wikipedia/commons/4/47/Chess_qdt45.svg',
  bR: 'https://upload.wikimedia.org/wikipedia/commons/f/ff/Chess_rdt45.svg',
  bB: 'https://upload.wikimedia.org/wikipedia/commons/9/98/Chess_bdt45.svg',
  bN: 'https://upload.wikimedia.org/wikipedia/commons/e/ef/Chess_ndt45.svg',
  bP: 'https://upload.wikimedia.org/wikipedia/commons/c/c7/Chess_pdt45.svg',
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STOCKFISH ENGINE (asm.js blob-worker)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const STOCKFISH_URL = 'https://cdn.jsdelivr.net/npm/stockfish.js@10.0.2/stockfish.js';

class UCIEngine {
  constructor() { this.worker = null; this._listeners = []; this._queue = Promise.resolve(); }

  async init() {
    const code = `importScripts(${JSON.stringify(STOCKFISH_URL)});`;
    const blob = new Blob([code], { type: 'application/javascript' });
    this.worker = new Worker(URL.createObjectURL(blob));

    this.worker.onmessage = (e) => {
      const line = String(e.data || '').trim();
      if (!line) return;
      this._listeners.forEach(fn => fn(line));
    };
    this.worker.onerror = (err) => vlog('WORKER ERR: ' + (err.message || err));

    await this._wait('uciok',   () => this.send('uci'),    12000);
    await this._wait('readyok', () => this.send('isready'), 12000);
    this.send('ucinewgame');
    await this._wait('readyok', () => this.send('isready'), 12000);
  }

  send(cmd) { this.worker.postMessage(cmd); }

  _wait(token, kick, ms) {
    return new Promise((res, rej) => {
      let done = false;
      const t = setTimeout(() => { if (!done) { done = true; rm(); rej(new Error('Timeout: ' + token)); } }, ms);
      const fn = (line) => { if (!done && line.includes(token)) { done = true; clearTimeout(t); rm(); res(); } };
      const rm = () => { this._listeners = this._listeners.filter(x => x !== fn); };
      this._listeners.push(fn);
      kick();
    });
  }

  analyze(fen, multipv, depth) {
    this._queue = this._queue.then(() => this._run(fen, multipv, depth));
    return this._queue;
  }

  _run(fen, multipv, depth) {
    return new Promise((res, rej) => {
      const pvs = new Map();
      let done = false;
      const t = setTimeout(() => { cleanup(); rej(new Error('Analysis timeout')); }, 18000);
      const fn = (line) => {
        if (line.startsWith('info ')) {
          const mp = /multipv\s+(\d+)/.exec(line);
          const pv = /\bpv\s+([a-h][1-8][a-h][1-8][qrbn]?)/.exec(line);
          if (!pv) return;
          const idx = mp ? +mp[1] : 1;
          let cp = null, mate = null, scoreText = '';
          const mCp = /score\s+cp\s+(-?\d+)/.exec(line);
          const mM  = /score\s+mate\s+(-?\d+)/.exec(line);
          if (mM) { mate = +mM[1]; scoreText = (mate > 0 ? '#+' : '#') + mate; }
          else if (mCp) { cp = +mCp[1]; scoreText = (cp >= 0 ? '+' : '') + (cp / 100).toFixed(2); }
          pvs.set(idx, { uci: pv[1], cp, mate, scoreText });
        }
        if (line.startsWith('bestmove ')) {
          if (done) return;
          done = true; cleanup();
          const out = [];
          for (let i = 1; i <= multipv; i++) if (pvs.has(i)) out.push({ pv: i, ...pvs.get(i) });
          res(out);
        }
      };
      const cleanup = () => { clearTimeout(t); this._listeners = this._listeners.filter(x => x !== fn); try { this.send('stop'); } catch(_){} };
      this._listeners.push(fn);
      this.send('setoption name MultiPV value ' + multipv);
      this.send('position fen ' + fen);
      this.send('go depth ' + depth);
    });
  }
}

const sfEngine = new UCIEngine();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SETTINGS MANAGEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const SETTINGS_KEY = 'betchess_settings_v3';

function defaultSettings() {
  return {
    bankroll: 25,
    cost1: 3, cost2: 2, cost3: 1,
    freeMoves: 1,
    depthOffers: 12,
    depthEngine: 12,
    mode: 'stockfish',
    llmPrompt: ''
  };
}

function loadSettings() {
  try {
    const s = JSON.parse(localStorage.getItem(SETTINGS_KEY));
    return { ...defaultSettings(), ...s };
  } catch (_) { return defaultSettings(); }
}

function saveSettings(s) { localStorage.setItem(SETTINGS_KEY, JSON.stringify(s)); }

function settingsToUI(s) {
  document.getElementById('s_bankroll').value = s.bankroll;
  document.getElementById('s_cost1').value = s.cost1;
  document.getElementById('s_cost2').value = s.cost2;
  document.getElementById('s_cost3').value = s.cost3;
  document.getElementById('s_freeMoves').value = s.freeMoves;
  document.getElementById('s_depthOffers').value = s.depthOffers;
  document.getElementById('s_depthEngine').value = s.depthEngine;
  if (s.llmPrompt) document.getElementById('s_llmPrompt').value = s.llmPrompt;
  document.querySelectorAll('#modeToggle .opt').forEach(o => {
    o.classList.toggle('active', o.dataset.mode === s.mode);
  });
  document.getElementById('llmExtraSettings').style.display = (s.mode === 'llm') ? 'block' : 'none';
}

function settingsFromUI() {
  const mode = document.querySelector('#modeToggle .opt.active')?.dataset.mode || 'stockfish';
  return {
    bankroll: Math.max(1, +document.getElementById('s_bankroll').value || 25),
    cost1: Math.max(0, +document.getElementById('s_cost1').value || 3),
    cost2: Math.max(0, +document.getElementById('s_cost2').value || 2),
    cost3: Math.max(0, +document.getElementById('s_cost3').value || 1),
    freeMoves: Math.max(0, +document.getElementById('s_freeMoves').value || 0),
    depthOffers: Math.max(4, +document.getElementById('s_depthOffers').value || 12),
    depthEngine: Math.max(4, +document.getElementById('s_depthEngine').value || 12),
    mode,
    llmPrompt: document.getElementById('s_llmPrompt').value,
  };
}

let CFG = loadSettings();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let game          = new Chess();
let board         = null;
let bankroll      = CFG.bankroll;
let moveNum       = 0;
let freeMovesLeft = CFG.freeMoves;
let freeMode      = false;
let locked        = false;
let currentOffers = [];
let llmPromptText = '';   // generated prompt for LLM mode

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UI REFERENCES + HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const $turn      = document.getElementById('ui_turn');
const $bank      = document.getElementById('ui_bank');
const $moveNum   = document.getElementById('ui_moveNum');
const $status    = document.getElementById('ui_status');
const $offers    = document.getElementById('offers');
const $log       = document.getElementById('log');
const $vlog      = document.getElementById('verboseLog');
const $bankFill  = document.getElementById('bankFill');
const $freeBtn   = document.getElementById('freeBtn');
const $freeCount = document.getElementById('ui_freeCount');
const $opponent  = document.getElementById('ui_opponent');
const $llmZone   = document.getElementById('llmZone');

function toast(msg, ok = true) {
  const t = document.getElementById('toast');
  t.className = 'toast' + (ok ? '' : ' err');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

function mlog(s) {
  $log.textContent = ($log.textContent ? $log.textContent + '\n' : '') + s;
  $log.scrollTop = $log.scrollHeight;
}

function vlog(s) {
  $vlog.textContent = ($vlog.textContent ? $vlog.textContent + '\n' : '') + s;
  $vlog.scrollTop = $vlog.scrollHeight;
}

function setStatus(html) { $status.innerHTML = html; }
function money(n) { return '$' + Math.max(0, n).toLocaleString(undefined, { maximumFractionDigits: 0 }); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MOVE HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function uciToObj(uci) {
  const from = uci.slice(0, 2), to = uci.slice(2, 4);
  const promo = uci.length > 4 ? uci[4] : undefined;
  return promo ? { from, to, promotion: promo } : { from, to };
}

function uciToSAN(uci) {
  const tmp = new Chess(game.fen());
  const m = tmp.move(uciToObj(uci));
  return m ? m.san : uci;
}

function isGameOver() {
  if (game.in_checkmate()) return (game.turn() === 'w' ? 'Black' : 'White') + ' wins by checkmate!';
  if (game.in_stalemate()) return 'Stalemate â€” draw.';
  if (game.in_threefold_repetition()) return 'Threefold repetition â€” draw.';
  if (game.insufficient_material()) return 'Insufficient material â€” draw.';
  if (game.in_draw()) return 'Draw.';
  return null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BOARD HIGHLIGHTING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function highlightMove(fromSq, toSq, color) {
  const el = document.getElementById('board');
  if (!el) return;
  el.querySelectorAll('[data-square]').forEach(sq => {
    const s = sq.getAttribute('data-square');
    if (s === fromSq || s === toSq) sq.style.boxShadow = `inset 0 0 0 5px ${color}`;
  });
}

function clearHighlights() {
  const el = document.getElementById('board');
  if (!el) return;
  el.querySelectorAll('[data-square]').forEach(sq => { sq.style.boxShadow = ''; });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UI SYNC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function syncUI() {
  $turn.textContent = game.turn() === 'w' ? 'White' : 'Black';
  $bank.textContent = money(bankroll);
  $moveNum.textContent = moveNum;

  const pct = Math.max(0, Math.min(100, (bankroll / CFG.bankroll) * 100));
  $bankFill.style.width = pct + '%';
  $bankFill.className = 'bank-fill' + (pct < 25 ? ' low' : '');

  const pillBank = document.getElementById('pillBank');
  pillBank.className = 'pill ' + (bankroll > CFG.bankroll * 0.33 ? 'good' : bankroll > 0 ? 'warn' : 'bad');

  $freeCount.textContent = freeMovesLeft;
  $freeBtn.className = 'free-tag' + (freeMovesLeft <= 0 || game.turn() !== 'w' ? ' disabled' : '');
  if (freeMode) {
    $freeBtn.style.background = 'rgba(92,204,111,0.25)';
    $freeBtn.style.borderColor = 'rgba(92,204,111,0.6)';
  } else {
    $freeBtn.style.background = '';
    $freeBtn.style.borderColor = '';
  }

  if (CFG.mode === 'llm') {
    $opponent.textContent = 'ğŸ§  LLM (copy-paste)';
  } else {
    $opponent.textContent = 'â™Ÿ Stockfish depth ' + CFG.depthEngine;
  }

  const over = isGameOver();
  if (over) { setStatus(over); hideLLMZone(); return; }
  if (bankroll <= 0 && freeMovesLeft <= 0) { setStatus('ğŸ’€ Bankrupt â€” you lose!'); hideLLMZone(); return; }
}

function syncBoard() {
  board.position(game.fen(), true);
  syncUI();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  OFFERS â€” MultiPV analysis, priced by rank
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function buildOffers() {
  if (game.turn() !== 'w') return;
  if (bankroll <= 0 && freeMovesLeft <= 0) return;

  currentOffers = [];
  $offers.innerHTML = '';
  clearHighlights();
  hideLLMZone();
  setStatus('<span class="spin"></span> Analyzing 3 offersâ€¦');
  vlog(`â”€â”€ Move ${moveNum + 1}: MultiPV=3, depth=${CFG.depthOffers}â€¦`);

  let raw;
  try {
    raw = await sfEngine.analyze(game.fen(), 3, CFG.depthOffers);
  } catch (err) {
    setStatus('Engine error â€” see log.');
    vlog('ERR: ' + (err.message || err));
    return;
  }

  // Pad to 3 if fewer legal moves exist
  const legals = game.moves({ verbose: true }).map(m => m.from + m.to + (m.promotion || ''));
  const seen = new Set(raw.map(o => o.uci));
  for (const u of legals) {
    if (raw.length >= 3) break;
    if (!seen.has(u)) { raw.push({ pv: raw.length + 1, uci: u, cp: null, mate: null, scoreText: '?' }); seen.add(u); }
  }

  const costs = [CFG.cost1, CFG.cost2, CFG.cost3];
  currentOffers = raw.slice(0, 3).map((o, i) => ({
    ...o,
    cost: costs[i] || 0,
    san: uciToSAN(o.uci),
    from: o.uci.slice(0, 2),
    to: o.uci.slice(2, 4),
  }));

  renderOffers();
  setStatus('Pick an offer â†“' + (freeMovesLeft > 0 ? ' or use a FREE move' : ''));
  vlog('3 offers ready.');
}

function renderOffers() {
  $offers.innerHTML = '';
  const rankClasses = ['r1', 'r2', 'r3'];
  const hlColors = ['rgba(224,164,76,0.45)', 'rgba(160,180,170,0.35)', 'rgba(120,130,125,0.28)'];

  currentOffers.forEach((o, i) => {
    const canAfford = bankroll >= o.cost;
    const row = document.createElement('div');
    row.className = 'offer';

    // Hover â†’ highlight move on board
    row.addEventListener('mouseenter', () => { clearHighlights(); highlightMove(o.from, o.to, hlColors[i]); });
    row.addEventListener('mouseleave', () => { clearHighlights(); });

    const rank = document.createElement('div');
    rank.className = 'rank ' + rankClasses[i];
    rank.textContent = i + 1;

    const info = document.createElement('div');
    info.className = 'move-info';
    const san = document.createElement('div'); san.className = 'san'; san.textContent = o.san;
    const ev = document.createElement('div'); ev.className = 'eval'; ev.textContent = `eval ${o.scoreText || 'â€”'}  Â·  ${o.uci}`;
    info.appendChild(san); info.appendChild(ev);

    const right = document.createElement('div'); right.className = 'right';
    const cost = document.createElement('div'); cost.className = 'cost'; cost.textContent = o.cost > 0 ? `$${o.cost}` : 'FREE';
    const btn = document.createElement('button');
    btn.className = canAfford || o.cost === 0 ? 'primary sm' : 'sm';
    btn.textContent = canAfford || o.cost === 0 ? 'Play' : 'Broke';
    btn.disabled = !(canAfford || o.cost === 0);
    btn.onclick = () => playOffer(o);
    right.appendChild(cost); right.appendChild(btn);

    row.appendChild(rank); row.appendChild(info); row.appendChild(right);
    $offers.appendChild(row);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PLAY MOVES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function playOffer(offer) {
  if (locked || game.turn() !== 'w') return;
  if (bankroll < offer.cost && offer.cost > 0) return;
  locked = true;
  exitFreeMode();
  clearHighlights();

  bankroll -= offer.cost;
  moveNum++;
  mlog(`${moveNum}. ${offer.san}  (âˆ’$${offer.cost}, bank ${money(bankroll)})`);

  const m = game.move(uciToObj(offer.uci));
  if (!m) { vlog('!! Illegal offer: ' + offer.uci); locked = false; return; }

  currentOffers = [];
  $offers.innerHTML = '';
  syncBoard();

  if (bankroll <= 0 && freeMovesLeft <= 0) { setStatus('ğŸ’€ Bankrupt â€” you lose!'); mlog('BANKRUPT.'); locked = false; return; }
  const over = isGameOver();
  if (over) { setStatus(over); mlog('GAME OVER: ' + over); locked = false; return; }

  await playBlack();
  locked = false;
}

async function playFreeMove(from, to, promotion) {
  if (locked || game.turn() !== 'w' || freeMovesLeft <= 0) return 'snapback';
  locked = true;

  const moveObj = promotion ? { from, to, promotion } : { from, to };
  const m = game.move(moveObj);
  if (!m) { locked = false; return 'snapback'; }

  freeMovesLeft--;
  moveNum++;
  mlog(`${moveNum}. ${m.san}  (FREE, bank ${money(bankroll)})`);
  exitFreeMode();
  clearHighlights();
  currentOffers = [];
  $offers.innerHTML = '';
  syncBoard();

  if (bankroll <= 0 && freeMovesLeft <= 0) { setStatus('ğŸ’€ Bankrupt!'); locked = false; return; }
  const over = isGameOver();
  if (over) { setStatus(over); locked = false; return; }

  await playBlack();
  locked = false;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BLACK'S MOVE â€” Stockfish or LLM (Prymis-style)
//
//  Stockfish mode: automatic, engine plays immediately.
//  LLM mode: shows the paste zone, waits for user to
//    copy prompt â†’ paste into AI â†’ paste JSON back.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function playBlack() {
  if (game.turn() !== 'b') return;

  if (CFG.mode === 'llm') {
    // â”€â”€ LLM MODE: Show paste zone, generate prompt â”€â”€
    showLLMZone();
    return; // Execution continues when user clicks "Parse & Play"
  }

  // â”€â”€ STOCKFISH MODE: Automatic â”€â”€
  await playBlackStockfish();
}

async function playBlackStockfish() {
  setStatus('<span class="spin"></span> Stockfish thinkingâ€¦');
  vlog('Stockfish thinking (depth ' + CFG.depthEngine + ')â€¦');

  let bestUci;
  try {
    const lines = await sfEngine.analyze(game.fen(), 1, CFG.depthEngine);
    bestUci = lines?.[0]?.uci;
  } catch (err) {
    vlog('SF ERROR: ' + (err.message || err));
    setStatus('Engine error.');
    return;
  }

  if (!bestUci) { vlog('No move received.'); setStatus('No opponent move.'); return; }
  executeBlackMove(bestUci);
  await buildOffers();
}

function executeBlackMove(uci) {
  const san = (() => { const tmp = new Chess(game.fen()); const m = tmp.move(uciToObj(uci)); return m ? m.san : uci; })();
  const m = game.move(uciToObj(uci));
  if (!m) { vlog('!! Illegal opponent: ' + uci); setStatus('Illegal opponent move.'); return false; }

  mlog(`   â€¦${san}`);
  highlightMove(uci.slice(0, 2), uci.slice(2, 4), 'rgba(224,82,82,0.35)');
  syncBoard();

  const over = isGameOver();
  if (over) { setStatus(over); mlog('GAME OVER: ' + over); return false; }
  return true;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LLM PASTE ZONE â€” Prymis-style prompt builder
//
//  Generates a comprehensive prompt with:
//  - FEN position
//  - ASCII board diagram
//  - Full PGN move history
//  - All legal moves (UCI + SAN)
//  - The configurable system prompt
//  - Strict JSON output schema
//
//  User copies prompt â†’ pastes to any AI â†’ pastes JSON back.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function buildLLMPrompt() {
  const fen = game.fen();
  const history = game.history();                          // SAN history
  const historyUCI = game.history({ verbose: true })
    .map(m => m.from + m.to + (m.promotion || ''));       // UCI history

  // Get legal moves with both SAN and UCI
  const legalVerbose = game.moves({ verbose: true });
  const legalList = legalVerbose.map(m => {
    const uci = m.from + m.to + (m.promotion || '');
    return { san: m.san, uci };
  });

  // ASCII board from chess.js
  const asciiBoard = game.ascii();

  // Build the full move history as PGN-style notation
  let pgn = '';
  for (let i = 0; i < history.length; i++) {
    if (i % 2 === 0) pgn += Math.floor(i / 2 + 1) + '. ';
    pgn += history[i] + ' ';
  }

  // Get system prompt (user-customizable or default)
  const systemPrompt = CFG.llmPrompt || document.getElementById('s_llmPrompt').value;

  // JSON schema example
  const schema = {
    move: "e7e5",
    reasoning: "Brief explanation of why this move is best"
  };

  // Build the complete prompt
  const prompt = `${systemPrompt}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
CURRENT POSITION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

FEN: ${fen}

${asciiBoard}

MOVE HISTORY (PGN):
${pgn.trim() || '(opening position â€” no moves yet)'}

MOVE HISTORY (UCI):
${historyUCI.join(' ') || '(none)'}

It is BLACK's turn. Move number: ${Math.ceil((history.length + 1) / 2)}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
LEGAL MOVES (${legalList.length} available)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

${legalList.map(m => `${m.uci}  (${m.san})`).join('\n')}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
OUTPUT REQUIREMENT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Respond with a single JSON object ONLY. No text before or after.

REQUIRED SHAPE:
${JSON.stringify(schema, null, 2)}

RULES:
- "move" MUST be one of the UCI strings from the legal moves list above.
- "reasoning" should be a brief explanation (under 200 chars).
- No markdown, no code fences, no extra text. Just the JSON.

Choose your move now.`;

  return prompt;
}

function showLLMZone() {
  // Generate prompt
  llmPromptText = buildLLMPrompt();

  // Show the zone
  $llmZone.style.display = 'block';
  document.getElementById('llmStep').textContent = 'Step 1: Copy prompt';
  document.getElementById('llmPromptPreview').textContent = llmPromptText;
  document.getElementById('llmPaste').value = '';
  document.getElementById('llmReasoning').classList.remove('show');

  setStatus('Waiting for LLM responseâ€¦ (copy prompt â†’ paste to AI â†’ paste JSON back)');
  vlog('LLM prompt generated (' + llmPromptText.length + ' chars)');
}

function hideLLMZone() {
  $llmZone.style.display = 'none';
}

// Parse the pasted JSON response from the AI
function parseLLMResponse(raw) {
  const trimmed = raw.trim();
  if (!trimmed) return null;

  // Try direct JSON parse
  try { return JSON.parse(trimmed); } catch (_) {}

  // Try extracting from ```json ... ``` block
  const m1 = trimmed.match(/```json\s*([\s\S]*?)\s*```/i);
  if (m1) { try { return JSON.parse(m1[1]); } catch (_) {} }

  // Try extracting from ``` ... ``` block
  const m2 = trimmed.match(/```\s*([\s\S]*?)\s*```/i);
  if (m2) { try { return JSON.parse(m2[1]); } catch (_) {} }

  // Try extracting JSON object from within text
  const m3 = trimmed.match(/\{[\s\S]*"move"\s*:\s*"[a-h][1-8][a-h][1-8][qrbn]?"[\s\S]*\}/);
  if (m3) { try { return JSON.parse(m3[0]); } catch (_) {} }

  return null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LLM ZONE EVENT HANDLERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Copy prompt
document.getElementById('llmCopyPrompt').onclick = () => {
  if (!llmPromptText) { toast('No prompt generated', false); return; }
  navigator.clipboard.writeText(llmPromptText).then(() => {
    toast('Prompt copied!');
    document.getElementById('llmStep').textContent = 'Step 2: Paste to AI';
  });
};

// Copy just the JSON schema
document.getElementById('llmCopySchema').onclick = () => {
  const schema = JSON.stringify({ move: "e7e5", reasoning: "explanation" }, null, 2);
  navigator.clipboard.writeText(schema).then(() => toast('Schema copied'));
};

// Launch AI buttons (copy prompt + open in new tab)
document.querySelectorAll('.launch-grid button[data-ai]').forEach(btn => {
  btn.onclick = () => {
    if (!llmPromptText) { toast('No prompt yet', false); return; }
    const urls = {
      claude: 'https://claude.ai/new',
      gpt: 'https://chat.openai.com/',
      gemini: 'https://gemini.google.com/',
      deepseek: 'https://chat.deepseek.com/'
    };
    navigator.clipboard.writeText(llmPromptText).then(() => {
      window.open(urls[btn.dataset.ai] || urls.claude, '_blank');
      toast('Prompt copied â†’ openingâ€¦');
      document.getElementById('llmStep').textContent = 'Step 3: Paste JSON back';
    });
  };
});

// Parse & Play button â€” the core paste-back handler
document.getElementById('llmParsePlay').onclick = async () => {
  const raw = document.getElementById('llmPaste').value.trim();
  if (!raw) { toast('Paste the AI response first', false); return; }

  const obj = parseLLMResponse(raw);
  if (!obj) { toast('Could not parse JSON â€” paste a { "move": "...", "reasoning": "..." } object', false); return; }

  const moveUci = (obj.move || '').trim().toLowerCase();
  if (!moveUci) { toast('No "move" field in JSON', false); return; }

  // Validate it's a legal move
  const legalMoves = game.moves({ verbose: true }).map(m => m.from + m.to + (m.promotion || ''));
  if (!legalMoves.includes(moveUci)) {
    toast(`Illegal move: "${moveUci}" â€” not in legal moves list`, false);
    vlog(`LLM returned illegal move: "${moveUci}"`);
    vlog('Legal: ' + legalMoves.join(', '));
    return;
  }

  // Show reasoning if provided
  const reasoning = (obj.reasoning || obj.reason || obj.explanation || '').trim();
  if (reasoning) {
    document.getElementById('llmReasoningText').textContent = reasoning;
    document.getElementById('llmReasoning').classList.add('show');
    vlog('LLM reasoning: ' + reasoning);
  }

  vlog('LLM move: ' + moveUci);

  // Execute the move
  const ok = executeBlackMove(moveUci);
  hideLLMZone();

  // Clear the highlight after a moment
  setTimeout(() => clearHighlights(), 600);

  // If game continues, generate next offers
  if (ok) {
    await buildOffers();
  }
};

// "Use Stockfish Instead" â€” fallback for when you don't want to paste
document.getElementById('llmUseSF').onclick = async () => {
  hideLLMZone();
  vlog('Falling back to Stockfish for this move.');
  await playBlackStockfish();
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FREE MOVE MODE â€” Toggle board draggability
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function enterFreeMode() {
  if (freeMovesLeft <= 0 || game.turn() !== 'w' || locked) return;
  freeMode = true;
  board = rebuildBoard(true);
  syncUI();
  const moves = game.moves({ verbose: true });
  const targets = new Set(moves.map(m => m.to));
  targets.forEach(sq => highlightMove(sq, sq, 'rgba(92,204,111,0.15)'));
  setStatus('Drag a piece for a FREE move, or pick an offer.');
}

function exitFreeMode() {
  if (!freeMode) return;
  freeMode = false;
  board = rebuildBoard(false);
  clearHighlights();
  syncUI();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BOARD BUILDER (rebuild to toggle draggable)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function rebuildBoard(draggable) {
  const pos = game.fen();
  const cfg = {
    position: pos,
    orientation: 'white',
    draggable: !!draggable,
    pieceTheme: (piece) => PIECE_URLS[piece] || '',
    onDragStart: (source, piece) => {
      if (!freeMode) return false;
      if (game.game_over() || game.turn() !== 'w') return false;
      if (piece.search(/^b/) !== -1) return false;
      clearHighlights();
      const moves = game.moves({ verbose: true }).filter(m => m.from === source);
      moves.forEach(m => highlightMove(m.to, m.to, 'rgba(92,204,111,0.4)'));
      highlightMove(source, source, 'rgba(92,204,111,0.25)');
      return true;
    },
    onDrop: (source, target) => {
      clearHighlights();
      const piece = game.get(source);
      const isPromo = piece && piece.type === 'p' &&
        ((piece.color === 'w' && target[1] === '8') || (piece.color === 'b' && target[1] === '1'));
      const promotion = isPromo ? 'q' : undefined;
      const testGame = new Chess(game.fen());
      const m = testGame.move(promotion ? { from: source, to: target, promotion } : { from: source, to: target });
      if (!m) return 'snapback';
      playFreeMove(source, target, promotion);
    },
    onSnapEnd: () => { board.position(game.fen()); }
  };
  return Chessboard('board', cfg);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SETTINGS UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function openSettings() {
  settingsToUI(CFG);
  document.getElementById('settingsOverlay').classList.add('open');
  document.getElementById('settingsDrawer').classList.add('open');
}
function closeSettings() {
  document.getElementById('settingsOverlay').classList.remove('open');
  document.getElementById('settingsDrawer').classList.remove('open');
}

document.getElementById('btnSettings').onclick = openSettings;
document.getElementById('closeSettings').onclick = closeSettings;
document.getElementById('settingsOverlay').onclick = closeSettings;

document.querySelectorAll('#modeToggle .opt').forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll('#modeToggle .opt').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('llmExtraSettings').style.display = (btn.dataset.mode === 'llm') ? 'block' : 'none';
  };
});

document.getElementById('applySettings').onclick = async () => {
  CFG = settingsFromUI();
  saveSettings(CFG);
  closeSettings();
  toast('Settings applied');
  await startNewGame();
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME LIFECYCLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function startNewGame() {
  if (locked) return;
  locked = true;

  game.reset();
  bankroll = CFG.bankroll;
  moveNum = 0;
  freeMovesLeft = CFG.freeMoves;
  freeMode = false;
  currentOffers = [];

  $offers.innerHTML = '';
  $log.textContent = '';
  $vlog.textContent = '';
  clearHighlights();
  hideLLMZone();

  board = rebuildBoard(false);
  mlog('â•â•â• New Game â•â•â•');
  vlog('Bank: ' + money(bankroll) + ' | Free: ' + freeMovesLeft + ' | Mode: ' + CFG.mode);
  syncUI();

  await buildOffers();
  locked = false;
}

document.getElementById('btnNew').onclick = startNewGame;

document.getElementById('btnReroll').onclick = async () => {
  if (locked || game.turn() !== 'w') return;
  locked = true;
  clearHighlights();
  vlog('Re-rolling offersâ€¦');
  await buildOffers();
  locked = false;
};

document.getElementById('btnResign').onclick = () => {
  if (locked) return;
  setStatus('You resigned.');
  currentOffers = [];
  $offers.innerHTML = '';
  hideLLMZone();
  mlog('RESIGNED.');
};

$freeBtn.onclick = () => {
  if (freeMovesLeft <= 0 || game.turn() !== 'w' || locked) return;
  freeMode ? exitFreeMode() : enterFreeMode();
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function init() {
  CFG = loadSettings();
  settingsToUI(CFG);
  bankroll = CFG.bankroll;
  freeMovesLeft = CFG.freeMoves;

  board = rebuildBoard(false);
  syncUI();

  mlog('Loading Stockfishâ€¦');
  vlog('Loading Stockfish (asm.js)â€¦');
  setStatus('<span class="spin"></span> Loading engineâ€¦');

  try {
    await sfEngine.init();
  } catch (err) {
    setStatus('Stockfish failed to load.');
    vlog('INIT ERROR: ' + (err.message || err));
    vlog('Serve via HTTP if local (python3 -m http.server)');
    toast('Engine failed to load', false);
    return;
  }

  vlog('Stockfish ready.');
  mlog('Engine ready.');
  setStatus('Ready!');
  await buildOffers();
}

init();

})();
</script>
</body>
</html>
